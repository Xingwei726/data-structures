{"filter":false,"title":"week07_insertData.js","tooltip":"/week7/week07_insertData.js","undoManager":{"mark":31,"position":31,"stack":[[{"start":{"row":0,"column":0},"end":{"row":32,"column":8},"action":"remove","lines":["const { Client } = require('pg');","const dotenv = require('dotenv');","const fs = require('fs');","dotenv.config({ path: '/home/ec2-user/environment/week4/.env' });","var async = require('async');","","// AWS RDS POSTGRESQL INSTANCE","const db_credentials = new Object({","   user: \"huanx429\",","   password: process.env.AWSRDS_PW,","   host: \"database-structures.c9iddlpctkv6.us-east-1.rds.amazonaws.com\",","   database: \"aa\",","   port: 5432,","});","","var rawAddresses = fs.readFileSync('../week3/data/AA091.json');","var addressesForDb = JSON.parse(rawAddresses);","var items = addressesForDb;","// // var addressesForDb = parseJson({AA091}, “$.items.qty”)","// // console.log (addressesForDb.locationTitle);","console.log (items);","","// async.eachSeries(addressesForDb, function (value, callback) {","//     const client = new Client(db_credentials);","//     client.connect();","//     var thisQuery = \"INSERT INTO aalocations (locationName, streetInfo, city, state, zip, details, wheelchair_access, zone, latitude, longitude) VALUES (E'\" + value.locationTitle + \"','\" + value.streetInfo + \"', '\" + value.city + \"', '\" + value.state + \"', '\"+ value.zip + \"', '\" + value.details + \"', '\" + value.latitude + \"', '\"+value.longitude + \"');\";","","//     client.query(thisQuery, (err, res) => {","//          console.log(err, res);","//          client.end();","//     });","//     setTimeout(callback, 2000);","// });  "],"id":2},{"start":{"row":0,"column":0},"end":{"row":95,"column":3},"action":"insert","lines":["const { Client } = require('pg');","const async = require('async');","var escape = require('pg-escape');","","const dotenv = require('dotenv').config();","const fs = require('fs');","","// AWS RDS POSTGRESQL INSTANCE","var db_credentials = new Object();","db_credentials.user = 'AAAdmin';","db_credentials.host = 'database-structures.csjve6pmlqxu.us-east-2.rds.amazonaws.com';","db_credentials.database = 'aa';","db_credentials.password = process.env.AWSRDS_PW;","db_credentials.port = 5432;","","//Read the previously saved json file","fs.readFile('data/AA-complete-data.json', 'utf8', (error, data) => {","    if (error) throw error;","    //parse the json so it cant be used as an object","    var meetings = JSON.parse(data);","","    //for each element in the json, extract the location name","    async.forEachOf(meetings, function(locationObj,location, callback) {","        const client = new Client(db_credentials);","        client.connect();","        ","        //create a query string with the values from the json to be entered into the locations table (values are enetered in order), returning the assigned location id to be used for the groups table","        var locationQuery = escape(\"INSERT INTO locations VALUES (DEFAULT, %L,%L,%L,%L,%L,%s,%L,%s,%s,%s) RETURNING Location_ID;\",","        location,","        meetings[location]['address']['line_1'],","        meetings[location]['address']['city'],","        meetings[location]['address']['state'],","        meetings[location]['address']['zip'],","        meetings[location]['address']['wheelchair_access'],","        meetings[location]['address']['friendly'],","        meetings[location]['address']['coords']['latitude'],","        meetings[location]['address']['coords']['longitude'],","        meetings[location]['address']['zone']);","        ","        //create a query using the query string","        client.query(locationQuery, (err, res) => {","            if (err) {","                console.log(err, locationQuery);","            } else {","                // in the information has been enetered correct and a new location ID has been created, continue to add the groups associated with that location","                console.log('Location ID: ' + res.rows[0].location_id);","                client.end();","                // for each of the nested groups, create a query string and add them to the groups table","                async.forEachOf(meetings[location]['meetings'], function(groupObj,group, callback) {","                    const client = new Client(db_credentials);","                    client.connect();","                        var meetingQuery = escape(\"INSERT INTO groups VALUES (DEFAULT, %s, %L, %L) RETURNING Group_ID;\", res.rows[0].location_id, group, meetings[location]['meetings'][group]['details']);","","                    client.query(meetingQuery, (err, res) => {","                        if (err) {","                            console.log(err, meetingQuery);","                        } else {","                            // in the information has been enetered correct and a new group ID has been created, continue to add the events associated with that group","                            console.log('Group ID: ' + res.rows[0].group_id);","                            client.end();","                            ","                            async.forEachOf(meetings[location]['meetings'][group]['times'], function(eventObj,event, callback) {","                                const client = new Client(db_credentials);","                                client.connect();","                                    var eventQuery = escape(\"INSERT INTO events VALUES (DEFAULT, %s, %L, %L, %L, %L, %L) RETURNING Event_ID;\",","                                    res.rows[0].group_id,","                                    meetings[location]['meetings'][group]['times'][event]['day'],","                                    meetings[location]['meetings'][group]['times'][event]['start'],","                                    meetings[location]['meetings'][group]['times'][event]['end'],","                                    meetings[location]['meetings'][group]['times'][event]['type'],","                                    meetings[location]['meetings'][group]['times'][event]['specialInterest']","                                    );","","                                client.query(eventQuery, (err, res) => {","                                    if (err) {","                                        console.log(err, eventQuery);","                                    } else {","                                        //confirm that the events have been created","                                        console.log('Event ID: ' + res.rows[0].event_id);","                                        client.end();","                                    }","                                });","                            ","                            setTimeout(callback, 2000); ","                            });","                        }","                    });","                ","                setTimeout(callback, 2000); ","                });","            }","        });","    ","    setTimeout(callback, 2000); ","    }); ","});"]}],[{"start":{"row":16,"column":20},"end":{"row":16,"column":34},"action":"remove","lines":["-complete-data"],"id":3},{"start":{"row":16,"column":20},"end":{"row":16,"column":21},"action":"insert","lines":["A"]},{"start":{"row":16,"column":21},"end":{"row":16,"column":22},"action":"insert","lines":["l"]},{"start":{"row":16,"column":22},"end":{"row":16,"column":23},"action":"insert","lines":["l"]}],[{"start":{"row":29,"column":39},"end":{"row":29,"column":45},"action":"remove","lines":["line_1"],"id":4},{"start":{"row":29,"column":39},"end":{"row":29,"column":40},"action":"insert","lines":["s"]},{"start":{"row":29,"column":40},"end":{"row":29,"column":41},"action":"insert","lines":["t"]},{"start":{"row":29,"column":41},"end":{"row":29,"column":42},"action":"insert","lines":["r"]},{"start":{"row":29,"column":42},"end":{"row":29,"column":43},"action":"insert","lines":["e"]},{"start":{"row":29,"column":43},"end":{"row":29,"column":44},"action":"insert","lines":["e"]},{"start":{"row":29,"column":44},"end":{"row":29,"column":45},"action":"insert","lines":["t"]}],[{"start":{"row":29,"column":39},"end":{"row":29,"column":45},"action":"remove","lines":["street"],"id":5},{"start":{"row":29,"column":39},"end":{"row":29,"column":49},"action":"insert","lines":["streetInfo"]}],[{"start":{"row":34,"column":39},"end":{"row":34,"column":47},"action":"remove","lines":["friendly"],"id":6},{"start":{"row":34,"column":39},"end":{"row":34,"column":40},"action":"insert","lines":["d"]},{"start":{"row":34,"column":40},"end":{"row":34,"column":41},"action":"insert","lines":["e"]},{"start":{"row":34,"column":41},"end":{"row":34,"column":42},"action":"insert","lines":["t"]}],[{"start":{"row":34,"column":39},"end":{"row":34,"column":42},"action":"remove","lines":["det"],"id":7},{"start":{"row":34,"column":39},"end":{"row":34,"column":46},"action":"insert","lines":["details"]}],[{"start":{"row":27,"column":116},"end":{"row":27,"column":127},"action":"remove","lines":["Location_ID"],"id":8},{"start":{"row":27,"column":116},"end":{"row":27,"column":117},"action":"insert","lines":["l"]},{"start":{"row":27,"column":117},"end":{"row":27,"column":118},"action":"insert","lines":["o"]},{"start":{"row":27,"column":118},"end":{"row":27,"column":119},"action":"insert","lines":["c"]},{"start":{"row":27,"column":119},"end":{"row":27,"column":120},"action":"insert","lines":["a"]},{"start":{"row":27,"column":120},"end":{"row":27,"column":121},"action":"insert","lines":["t"]},{"start":{"row":27,"column":121},"end":{"row":27,"column":122},"action":"insert","lines":["o"]}],[{"start":{"row":27,"column":121},"end":{"row":27,"column":122},"action":"remove","lines":["o"],"id":9}],[{"start":{"row":27,"column":121},"end":{"row":27,"column":122},"action":"insert","lines":["i"],"id":10},{"start":{"row":27,"column":122},"end":{"row":27,"column":123},"action":"insert","lines":["o"]},{"start":{"row":27,"column":123},"end":{"row":27,"column":124},"action":"insert","lines":["n"]}],[{"start":{"row":27,"column":116},"end":{"row":27,"column":124},"action":"remove","lines":["location"],"id":11},{"start":{"row":27,"column":116},"end":{"row":27,"column":126},"action":"insert","lines":["locationID"]}],[{"start":{"row":45,"column":29},"end":{"row":45,"column":40},"action":"remove","lines":["Location ID"],"id":12},{"start":{"row":45,"column":29},"end":{"row":45,"column":39},"action":"insert","lines":["locationID"]}],[{"start":{"row":45,"column":57},"end":{"row":45,"column":68},"action":"remove","lines":["location_id"],"id":13},{"start":{"row":45,"column":57},"end":{"row":45,"column":67},"action":"insert","lines":["locationID"]}],[{"start":{"row":78,"column":53},"end":{"row":78,"column":61},"action":"remove","lines":["Event ID"],"id":14},{"start":{"row":78,"column":53},"end":{"row":78,"column":63},"action":"insert","lines":["meetingsID"]}],[{"start":{"row":64,"column":131},"end":{"row":64,"column":139},"action":"remove","lines":["Event_ID"],"id":15},{"start":{"row":64,"column":131},"end":{"row":64,"column":141},"action":"insert","lines":["meetingsID"]}],[{"start":{"row":58,"column":41},"end":{"row":58,"column":49},"action":"remove","lines":["Group ID"],"id":16},{"start":{"row":58,"column":41},"end":{"row":58,"column":42},"action":"insert","lines":["g"]},{"start":{"row":58,"column":42},"end":{"row":58,"column":43},"action":"insert","lines":["r"]},{"start":{"row":58,"column":43},"end":{"row":58,"column":44},"action":"insert","lines":["o"]},{"start":{"row":58,"column":44},"end":{"row":58,"column":45},"action":"insert","lines":["u"]},{"start":{"row":58,"column":45},"end":{"row":58,"column":46},"action":"insert","lines":["p"]},{"start":{"row":58,"column":46},"end":{"row":58,"column":47},"action":"insert","lines":["I"]}],[{"start":{"row":58,"column":47},"end":{"row":58,"column":48},"action":"insert","lines":["D"],"id":17}],[{"start":{"row":58,"column":66},"end":{"row":58,"column":74},"action":"remove","lines":["group_id"],"id":18},{"start":{"row":58,"column":66},"end":{"row":58,"column":73},"action":"insert","lines":["groupID"]}],[{"start":{"row":70,"column":0},"end":{"row":71,"column":0},"action":"remove","lines":["                                    meetings[location]['meetings'][group]['times'][event]['specialInterest']",""],"id":19}],[{"start":{"row":67,"column":91},"end":{"row":67,"column":96},"action":"remove","lines":["start"],"id":21},{"start":{"row":67,"column":91},"end":{"row":67,"column":100},"action":"insert","lines":["timeStart"]}],[{"start":{"row":68,"column":91},"end":{"row":68,"column":94},"action":"remove","lines":["end"],"id":22},{"start":{"row":68,"column":91},"end":{"row":68,"column":98},"action":"insert","lines":["timeEnd"]}],[{"start":{"row":64,"column":113},"end":{"row":64,"column":115},"action":"remove","lines":["%L"],"id":23}],[{"start":{"row":64,"column":113},"end":{"row":64,"column":114},"action":"remove","lines":[","],"id":24},{"start":{"row":64,"column":112},"end":{"row":64,"column":113},"action":"remove","lines":[" "]}],[{"start":{"row":51,"column":109},"end":{"row":51,"column":117},"action":"remove","lines":["Group_ID"],"id":25},{"start":{"row":51,"column":109},"end":{"row":51,"column":110},"action":"insert","lines":["g"]},{"start":{"row":51,"column":110},"end":{"row":51,"column":111},"action":"insert","lines":["r"]},{"start":{"row":51,"column":111},"end":{"row":51,"column":112},"action":"insert","lines":["o"]},{"start":{"row":51,"column":112},"end":{"row":51,"column":113},"action":"insert","lines":["u"]},{"start":{"row":51,"column":113},"end":{"row":51,"column":114},"action":"insert","lines":["p"]}],[{"start":{"row":51,"column":109},"end":{"row":51,"column":114},"action":"remove","lines":["group"],"id":26},{"start":{"row":51,"column":109},"end":{"row":51,"column":116},"action":"insert","lines":["groupID"]}],[{"start":{"row":51,"column":132},"end":{"row":51,"column":143},"action":"remove","lines":["location_id"],"id":27},{"start":{"row":51,"column":132},"end":{"row":51,"column":133},"action":"insert","lines":["l"]},{"start":{"row":51,"column":133},"end":{"row":51,"column":134},"action":"insert","lines":["o"]},{"start":{"row":51,"column":134},"end":{"row":51,"column":135},"action":"insert","lines":["c"]},{"start":{"row":51,"column":135},"end":{"row":51,"column":136},"action":"insert","lines":["a"]},{"start":{"row":51,"column":136},"end":{"row":51,"column":137},"action":"insert","lines":["t"]},{"start":{"row":51,"column":137},"end":{"row":51,"column":138},"action":"insert","lines":["i"]},{"start":{"row":51,"column":138},"end":{"row":51,"column":139},"action":"insert","lines":["o"]},{"start":{"row":51,"column":139},"end":{"row":51,"column":140},"action":"insert","lines":["n"]}],[{"start":{"row":51,"column":132},"end":{"row":51,"column":140},"action":"remove","lines":["location"],"id":28},{"start":{"row":51,"column":132},"end":{"row":51,"column":142},"action":"insert","lines":["locationID"]}],[{"start":{"row":27,"column":102},"end":{"row":27,"column":104},"action":"remove","lines":["%s"],"id":29},{"start":{"row":27,"column":101},"end":{"row":27,"column":102},"action":"remove","lines":[","]}],[{"start":{"row":8,"column":0},"end":{"row":13,"column":27},"action":"remove","lines":["var db_credentials = new Object();","db_credentials.user = 'AAAdmin';","db_credentials.host = 'database-structures.csjve6pmlqxu.us-east-2.rds.amazonaws.com';","db_credentials.database = 'aa';","db_credentials.password = process.env.AWSRDS_PW;","db_credentials.port = 5432;"],"id":30},{"start":{"row":8,"column":0},"end":{"row":14,"column":3},"action":"insert","lines":["const db_credentials = new Object({","   user: \"huanx429\",","   password: process.env.AWSRDS_PW,","   host: \"database-structures.c9iddlpctkv6.us-east-1.rds.amazonaws.com\",","   database: \"aa\",","   port: 5432,","});"]}],[{"start":{"row":8,"column":0},"end":{"row":14,"column":3},"action":"remove","lines":["const db_credentials = new Object({","   user: \"huanx429\",","   password: process.env.AWSRDS_PW,","   host: \"database-structures.c9iddlpctkv6.us-east-1.rds.amazonaws.com\",","   database: \"aa\",","   port: 5432,","});"],"id":31},{"start":{"row":8,"column":0},"end":{"row":14,"column":3},"action":"insert","lines":["const db_credentials = new Object({","   user: \"huanx429\",","   password: process.env.AWSRDS_PW,","   host: \"database-structures.c9iddlpctkv6.us-east-1.rds.amazonaws.com\",","   database: \"aa\",","   port: 5432,","});"]}],[{"start":{"row":28,"column":74},"end":{"row":28,"column":101},"action":"remove","lines":[" %L,%L,%L,%L,%L,%s,%L,%s,%s"],"id":32},{"start":{"row":28,"column":74},"end":{"row":28,"column":103},"action":"insert","lines":["%L,%L,%L,%L,%L,%s,%L,%s,%s,%s"]}],[{"start":{"row":52,"column":87},"end":{"row":52,"column":97},"action":"remove","lines":["%s, %L, %L"],"id":33},{"start":{"row":52,"column":87},"end":{"row":52,"column":97},"action":"insert","lines":["%s, %L, %L"]}],[{"start":{"row":65,"column":96},"end":{"row":65,"column":115},"action":"remove","lines":[" %s, %L, %L, %L, %L"],"id":34},{"start":{"row":65,"column":96},"end":{"row":65,"column":119},"action":"insert","lines":[" %s, %L, %L, %L, %L, %L"]}]]},"ace":{"folds":[],"scrolltop":254,"scrollleft":0,"selection":{"start":{"row":38,"column":47},"end":{"row":38,"column":47},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1572109919000,"hash":"5e793536e9e3ab8f5429de952b0305342a777e4d"}